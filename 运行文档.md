# Kronos Live Forecast - 运行文档

## 项目简介

Kronos Live Forecast 是一个基于 Kronos 金融基础模型的 BTC/USDT 价格预测演示系统。系统通过深度学习模型对未来24小时的加密货币价格进行概率性预测，并提供可视化的Web界面展示。

## 环境要求

### Python 版本
- Python 3.12.2 (推荐) 或更高版本

### 必需依赖库
```bash
pip3 install torch pandas numpy matplotlib python-binance huggingface_hub tqdm safetensors pyyaml
```

### 外部模型文件
- 路径：`../Kronos_model/` 
- 可用模型：
  - **Kronos-small**: 24.7M参数 (推荐日常使用，速度快)
  - **Kronos-base**: 102.3M参数 (更高精度，速度较慢)
  - **Kronos-Tokenizer-base**: 共享分词器
- ✅ 已确认存在并可用

### 配置文件
- **主配置**: `config.yaml` - 集中管理所有参数
- **模型切换**: 在配置文件中修改 `model.model_name`
- **性能调优**: 调整采样次数和数据窗口大小

## 运行方式

### 1. 单次预测运行 (推荐首次使用)

```bash
python3 update_predictions.py --single
```

**注意**：目前脚本默认会进入持续调度模式。建议修改代码仅运行一次：

临时修改 `update_predictions.py` 最后几行：
```python
if __name__ == '__main__':
    model_path = Path(Config["MODEL_PATH"])
    model_path.mkdir(parents=True, exist_ok=True)
    
    loaded_model = load_model()
    main_task(loaded_model)  # 只运行一次
    # run_scheduler(loaded_model)  # 注释掉调度器
    print("单次预测完成！")
```

### 2. 持续运行模式 (生产环境)

```bash
python3 update_predictions.py
```

- 每小时在XX:00:05自动运行预测
- 包含错误重试机制
- 自动提交Git更新

### 3. 本地Web服务查看结果

```bash
python3 -m http.server 8000
```

然后在浏览器访问：`http://localhost:8000`

## 运行过程说明

### 第一阶段：模型加载 (~30秒)
```
Loading Kronos model...
Model loaded successfully.
```

### 第二阶段：数据获取 (~10秒)
- 优先从币安API获取实时数据
- 如网络问题，自动切换为模拟数据
- 获取384小时(16天)的历史K线数据

### 第三阶段：AI预测生成 (~10分钟)
- 进行30次蒙特卡洛采样
- 每次采样约4秒，总计约2分钟
- 预测未来24小时价格走势
- 计算上涨概率和波动性指标

### 第四阶段：结果输出 (~30秒)
- 生成预测图表 `prediction_chart.png`
- 更新HTML仪表板 `index.html`
- 自动提交Git更新

## 输出文件

### 1. 预测图表
- **文件**：`prediction_chart.png`
- **内容**：历史价格(蓝线) + 预测均值(橙线) + 不确定性区间(阴影)

### 2. Web仪表板  
- **文件**：`index.html`
- **指标**：
  - 上涨概率 (Next 24h Upside Probability)
  - 波动性放大概率 (Volatility Amplification)
  - 最后更新时间

### 3. 样式文件
- **文件**：`style.css` 
- **功能**：响应式设计，支持深色/浅色主题

## 配置参数

通过 `config.yaml` 文件管理所有参数：

### 模型配置
```yaml
model:
  model_name: "Kronos-small"  # "Kronos-small" (24.7M) 或 "Kronos-base" (102.3M)
  max_context: 512
  device: "cpu"
```

### 采样配置
```yaml
sampling:
  temperature: 0.6      # 预测随机性 (0.1-1.0)
  top_p: 0.9           # Top-p采样 (0.1-1.0)
  num_samples: 30      # 蒙特卡洛采样次数
```

### 数据配置
```yaml
data:
  symbol: "BTCUSDT"
  history_window: 360   # 历史数据点数 (15天)
  forecast_horizon: 24  # 预测时间范围 (24小时)
  volatility_window: 24 # 波动性计算窗口
```

## 常见问题

### 1. 网络连接问题
```
方法1失败: HTTPSConnectionPool...
使用模拟数据进行测试...
```
**解决**：系统会自动使用模拟数据继续运行，不影响模型测试

### 2. 内存不足
**症状**：程序运行缓慢或崩溃
**解决**：
- 减少采样次数：`N_PREDICTIONS: 15`
- 减少历史数据：`HIST_POINTS: 180`

### 3. Git提交失败
**症状**：无法自动提交更新
**解决**：检查Git配置和仓库状态

### 4. 程序"死循环"
**原因**：程序设计为持续运行的调度器
**解决**：
- 单次运行：注释掉 `run_scheduler()` 调用
- 正常退出：使用 Ctrl+C 中断

## 性能优化建议

### 开发/测试环境
```yaml
model:
  model_name: "Kronos-small"  # 使用小模型，速度快

sampling:
  num_samples: 10             # 减少采样次数

data:
  history_window: 180         # 减少历史数据
```

### 生产环境
```yaml
model:
  model_name: "Kronos-base"   # 使用大模型，精度高

sampling:
  num_samples: 30             # 完整采样

data:
  history_window: 360         # 完整历史数据
```

### 模型性能对比

| 模型 | 参数量 | 预测时间 | 内存使用 | 推荐场景 |
|------|--------|----------|----------|----------|
| Kronos-small | 24.7M | ~5-8分钟 | 较低 | 开发测试、快速验证 |
| Kronos-base | 102.3M | ~10-15分钟 | 较高 | 生产环境、高精度预测 |

## 技术架构

- **AI模型**：
  - Kronos-small: 24.7M参数 (默认)
  - Kronos-base: 102.3M参数
  - 共享Kronos-Tokenizer-base分词器
- **推理设备**：CPU（已优化，支持CUDA）
- **配置管理**：YAML格式，环境变量支持
- **数据源**：币安API (实时) + 模拟数据 (备用)
- **可视化**：Matplotlib + HTML/CSS
- **部署**：Git自动化 + 静态文件服务
- **日志系统**：结构化日志，可配置级别

## 安全注意事项

- 使用公开API，无需密钥
- 仅读取市场数据，不进行交易
- 模型预测仅供参考，不构成投资建议

---

*最后更新：2025-08-24*