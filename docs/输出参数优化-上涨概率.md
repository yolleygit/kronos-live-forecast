# 🚀 **Upside Probability 增强指标组合**
全面评估加密货币24小时上涨概率：

## 📊 **完整指标体系**

### **1. upside_0.5%_prob** - 基础盈利概率
- **含义**：价格上涨至少0.5%的概率
- **作用**：覆盖交易成本的最低收益预期
- **参考值**：>70%为看涨信号

### **2. upside_2.0%_prob** - 显著收益概率  
- **含义**：价格上涨至少2.0%的概率
- **作用**：值得主动操作的收益阈值
- **参考值**：>45%为强看涨信号

### **3. upside_5.0%_prob** - 极端机会识别 ⭐
- **含义**：价格上涨至少5.0%的概率
- **作用**：**识别重大市场机会和异常波动**
- **参考值**：>25%为极强看涨，>15%为重要机会

### **4. expected_return_%** - 期望收益率
- **含义**：所有预测样本的平均预期收益
- **作用**：量化投资回报预期
- **参考值**：>1.5%为强看涨，0.5-1.5%为温和看涨

### **5. confidence_score** - 预测置信度
- **含义**：模型预测结果的一致性评分
- **作用**：评估预测可靠性，控制决策风险
- **参考值**：>0.80为高置信度，0.70-0.80为中高置信度

### **6. risk_adjusted_prob** - 风险调整概率
- **含义**：综合考虑收益和波动风险的上涨概率
- **作用**：提供更稳健的投资决策依据
- **参考值**：>0.70为稳健看涨，0.60-0.70为谨慎乐观

## 🎯 **指标组合实战应用**

### **强势看涨组合示例**
```python
upside_indicators = {
    'upside_0.5%_prob': 0.82,     # 82% - 高胜率
    'upside_2.0%_prob': 0.58,     # 58% - 强收益概率
    'upside_5.0%_prob': 0.28,     # 28% - 极端机会出现
    'expected_return_%': 2.1,      # 2.1% - 优秀期望收益
    'confidence_score': 0.85,      # 85% - 高置信度
    'risk_adjusted_prob': 0.72     # 72% - 风险调整后仍强势
}
# 决策：激进做多策略
```

### **谨慎乐观组合示例**
```python
upside_indicators = {
    'upside_0.5%_prob': 0.68,     # 68% - 温和看涨
    'upside_2.0%_prob': 0.35,     # 35% - 大涨概率一般
    'upside_5.0%_prob': 0.12,     # 12% - 极端机会较少
    'expected_return_%': 0.8,      # 0.8% - 小幅正收益
    'confidence_score': 0.72,      # 72% - 中等置信度
    'risk_adjusted_prob': 0.55     # 55% - 风险调整后偏中性
}
# 决策：小仓位试探策略
```

## ⚡ **核心优势**

1. **多层次阈值**：从保守(0.5%)到激进(5.0%)全覆盖
2. **风险控制**：置信度和风险调整双重验证
3. **极端识别**：5%阈值专门捕捉重大市场机会
4. **实战导向**：每个指标都有明确的交易决策含义
5. **加密适配**：针对加密货币高波动性特征优化
6. **概率量化**：将市场预期转化为可操作的概率数值

这套指标体系既能捕捉日常交易机会，更能识别那些**低频但高回报的极端市场机会**，为加密货币投资提供全方位的概率化决策支持！

# 🔢 **6个Upside Probability指标的具体计算方法**

## 📊 **基础数据结构**

```python
# 输入数据
hist_df = pd.DataFrame({
    'close': [历史价格序列],
    'timestamps': [时间序列]
})

close_preds_df = pd.DataFrame({
    'sample_1': [24小时预测价格序列],
    'sample_2': [24小时预测价格序列],
    ...
    'sample_30': [24小时预测价格序列]
})
# shape: (24行 × 30列) - 24小时 × 30个预测样本
```

## 💰 **指标1: upside_0.5%_prob - 基础盈利概率**

```python
def calculate_upside_05_prob(hist_df, close_preds_df):
    """计算上涨0.5%以上的概率"""
    last_close = hist_df['close'].iloc[-1]  # 当前价格
    threshold_price = last_close * (1 + 0.5/100)  # 0.5%阈值价格
    
    # 获取24小时后的预测价格（最后一行）
    final_hour_preds = close_preds_df.iloc[-1]  # 30个预测值
    
    # 计算超过阈值的样本比例
    upside_count = (final_hour_preds > threshold_price).sum()
    upside_prob = upside_count / len(final_hour_preds)
    
    return upside_prob

# 示例计算
# 当前价格: $60,000
# 阈值价格: $60,300 (上涨0.5%)
# 30个预测中有22个 > $60,300
# upside_0.5%_prob = 22/30 = 0.73 (73%)
```

## 📈 **指标2: upside_2.0%_prob - 显著收益概率**

```python
def calculate_upside_2_prob(hist_df, close_preds_df):
    """计算上涨2.0%以上的概率"""
    last_close = hist_df['close'].iloc[-1]
    threshold_price = last_close * (1 + 2.0/100)  # 2.0%阈值价格
    
    final_hour_preds = close_preds_df.iloc[-1]
    upside_count = (final_hour_preds > threshold_price).sum()
    upside_prob = upside_count / len(final_hour_preds)
    
    return upside_prob

# 示例计算
# 当前价格: $60,000
# 阈值价格: $61,200 (上涨2.0%)
# 30个预测中有13个 > $61,200
# upside_2.0%_prob = 13/30 = 0.43 (43%)
```

## 🚀 **指标3: upside_5.0%_prob - 极端机会识别**

```python
def calculate_upside_5_prob(hist_df, close_preds_df):
    """计算上涨5.0%以上的概率 - 极端市场机会"""
    last_close = hist_df['close'].iloc[-1]
    threshold_price = last_close * (1 + 5.0/100)  # 5.0%阈值价格
    
    final_hour_preds = close_preds_df.iloc[-1]
    upside_count = (final_hour_preds > threshold_price).sum()
    upside_prob = upside_count / len(final_hour_preds)
    
    return upside_prob

# 示例计算
# 当前价格: $60,000
# 阈值价格: $63,000 (上涨5.0%)
# 30个预测中有8个 > $63,000
# upside_5.0%_prob = 8/30 = 0.27 (27%)
```

## 💡 **指标4: expected_return_% - 期望收益率**

```python
def calculate_expected_return(hist_df, close_preds_df):
    """计算24小时期望收益率"""
    last_close = hist_df['close'].iloc[-1]
    final_hour_preds = close_preds_df.iloc[-1]
    
    # 计算每个预测样本的收益率
    returns = ((final_hour_preds / last_close - 1) * 100).values
    
    # 计算期望收益率（均值）
    expected_return = np.mean(returns)
    
    return expected_return

# 示例计算
# 当前价格: $60,000
# 30个预测价格: [$61,500, $59,800, $60,800, ...]
# 收益率: [2.5%, -0.33%, 1.33%, ...]
# expected_return = mean([2.5%, -0.33%, 1.33%, ...]) = 1.2%
```

## 🎯 **指标5: confidence_score - 预测置信度**

```python
def calculate_confidence_score(hist_df, close_preds_df):
    """计算预测置信度评分"""
    final_hour_preds = close_preds_df.iloc[-1]
    
    # 计算预测的统计特征
    prediction_mean = final_hour_preds.mean()
    prediction_std = final_hour_preds.std()
    
    # 变异系数 (CV = 标准差/均值)
    cv = prediction_std / (abs(prediction_mean) + 1e-8)  # 避免除零
    
    # 置信度评分（CV越小，置信度越高）
    confidence_score = 1 / (1 + cv)
    
    return confidence_score

# 示例计算
# 30个预测价格均值: $60,720
# 30个预测价格标准差: $1,200
# CV = $1,200 / $60,720 = 0.0198
# confidence_score = 1 / (1 + 0.0198) = 0.98 / 1.0198 = 0.85 (85%)
```

## ⚖️ **指标6: risk_adjusted_prob - 风险调整概率**

```python
def calculate_risk_adjusted_prob(hist_df, close_preds_df):
    """计算风险调整后的上涨概率"""
    
    # 方法1: 基于置信度调整
    base_upside_prob = calculate_upside_05_prob(hist_df, close_preds_df)
    confidence_score = calculate_confidence_score(hist_df, close_preds_df)
    
    # 简单的风险调整：基础概率 × 置信度
    risk_adj_prob_method1 = base_upside_prob * confidence_score
    
    # 方法2: 基于夏普比率调整（更复杂）
    last_close = hist_df['close'].iloc[-1]
    final_hour_preds = close_preds_df.iloc[-1]
    
    risk_adjusted_scores = []
    for pred_price in final_hour_preds:
        # 计算单个预测的收益率
        return_rate = (pred_price / last_close - 1) * 100
        
        # 计算该路径的波动率（简化版本）
        path = close_preds_df[final_hour_preds.name].values  # 完整24小时路径
        path_with_start = np.concatenate([[last_close], path])
        path_returns = np.diff(path_with_start) / path_with_start[:-1]
        volatility = np.std(path_returns) * 100 + 1e-8  # 避免除零
        
        # 风险调整收益 (类似夏普比率)
        risk_adj_return = return_rate / volatility
        risk_adjusted_scores.append(risk_adj_return)
    
    # 风险调整后的上涨概率
    risk_adj_prob_method2 = (np.array(risk_adjusted_scores) > 0).mean()
    
    # 选择其中一种方法或结合使用
    return risk_adj_prob_method1  # 推荐使用方法1，简单有效

# 示例计算
# base_upside_prob = 0.73 (73%)
# confidence_score = 0.85 (85%)
# risk_adjusted_prob = 0.73 × 0.85 = 0.62 (62%)
```

## 🔧 ** **

```python
def calculate_enhanced_upside_metrics(hist_df, close_preds_df):
    """计算完整的6项Upside Probability指标"""
    
    results = {}
    
    # 1. 基础盈利概率
    results['upside_0.5%_prob'] = calculate_upside_05_prob(hist_df, close_preds_df)
    
    # 2. 显著收益概率  
    results['upside_2.0%_prob'] = calculate_upside_2_prob(hist_df, close_preds_df)
    
    # 3. 极端机会识别
    results['upside_5.0%_prob'] = calculate_upside_5_prob(hist_df, close_preds_df)
    
    # 4. 期望收益率
    results['expected_return_%'] = calculate_expected_return(hist_df, close_preds_df)
    
    # 5. 预测置信度
    results['confidence_score'] = calculate_confidence_score(hist_df, close_preds_df)
    
    # 6. 风险调整概率
    results['risk_adjusted_prob'] = calculate_risk_adjusted_prob(hist_df, close_preds_df)
    
    return results

# 使用示例
metrics = calculate_enhanced_upside_metrics(hist_df, close_preds_df)
print(f"Upside 0.5%: {metrics['upside_0.5%_prob']:.1%}")
print(f"Upside 2.0%: {metrics['upside_2.0%_prob']:.1%}")
print(f"Upside 5.0%: {metrics['upside_5.0%_prob']:.1%}")
print(f"Expected Return: {metrics['expected_return_%']:.1f}%")
print(f"Confidence: {metrics['confidence_score']:.1%}")
print(f"Risk Adjusted: {metrics['risk_adjusted_prob']:.1%}")
```

## 🎯 **关键计算要点**

1. **时间点选择**：使用`close_preds_df.iloc[-1]`获取24小时后的预测价格
2. **阈值计算**：`threshold_price = current_price × (1 + percentage/100)`
3. **概率计算**：`(predictions > threshold).sum() / total_samples`
4. **置信度评估**：基于预测结果的变异系数
5. **风险调整**：结合基础概率和置信度评分

这套计算方法既保持了统计学的严谨性，又具有很强的实用性，为加密货币投资决策提供量化支持！